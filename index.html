<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Youtubify</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="https://cdn.plyr.io/3.6.1/plyr.css" />

</head>

<style>
    @import url('https://fonts.googleapis.com/css?family=Roboto&display=swap');
     :root {
        font-size: 16px;
    }
    
    * {
        font-family: 'Roboto', sans-serif;
    }
    
    body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh;
    }
    
    #container {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 100px;
        margin-top: 50px;
    }
    
    .video {
        width: 100%;
        height: auto;
        border-radius: 5px;
        background: #e9ebee;
    }
    
    .placeholder {
        width: 300px;
        height: 175px;
        background: #e9ebee;
    }
    
    #playerContainer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: white;
        z-index: 999;
    }
    
    #searchInput {
        margin: 1rem;
        width: 50vw;
        border: 2px solid #00b3ff25;
        padding: 10px;
        padding-left: 30px;
        border-radius: 5px;
        transition: border 300ms ease-in-out;
    }
    
    #searchInput:focus {
        border: 2px solid #00b3ff;
        outline: none;
    }
    
    .containerCenter {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border 300ms ease-in-out;
    }
    
    .card {
        width: 300px;
        word-wrap: break-word;
        margin: 10px;
        height: 350px;
    }
    
    .card .bars {
        height: 85px;
    }
    
    .card .bars .bar {
        background: #e9ebee;
        margin: 0 13px 13px;
        height: 19px;
        text-align: center;
    }
    
    .card .bars .bar1 {
        width: 80%;
        margin-top: 17px;
    }
    
    .card .bars .bar2 {
        width: 30%;
    }
    
    .loading {
        position: relative;
        overflow: hidden;
    }
    
    .loading::after {
        content: "";
        display: block;
        background-color: #dddfe2;
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        transform: translateX(0);
        animation: 1.5s loading-placeholder ease-in-out infinite;
    }
    
    @keyframes loading-placeholder {
        0% {
            transform: translateX(-100%);
        }
        100% {
            transform: translateX(100%);
        }
    }
    
    #details {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
        padding: 10px;
        z-index: 999;
    }
    
    .circle-img {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        margin-right: 20px;
    }
    
     ::-webkit-scrollbar {
        width: 5px;
    }
    /* Track */
    
     ::-webkit-scrollbar-track {
        background: transparent;
    }
    /* Handle */
    
     ::-webkit-scrollbar-thumb {
        background: #00b3ff6c;
    }
    /* Handle on hover */
    
     ::-webkit-scrollbar-thumb:hover {
        background: #00b3ff;
    }
    
    .fade-in {
        animation: fadeIn ease-in 500ms;
    }
    
    @keyframes fadeIn {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }
    
    .box {
        box-shadow: 0 2.8px 2.2px rgba(0, 0, 0, 0.034), 0 6.7px 5.3px rgba(0, 0, 0, 0.048), 0 12.5px 10px rgba(0, 0, 0, 0.06), 0 22.3px 17.9px rgba(0, 0, 0, 0.072), 0 41.8px 33.4px rgba(0, 0, 0, 0.086), 0 100px 80px rgba(0, 0, 0, 0.12);
    }
    
    .vid-title {
        text-align: center;
        padding-top: 10px;
    }
</style>

<body>
    <div class="containerCenter">
        <label style="text-align: center;" for="search"><input type="text" id="searchInput"
                placeholder="Search"></label>
    </div>
    <div id="playerContainer" class="box">
        <div id="details">
            <img class="circle-img" id="song-img" src="https://image.freepik.com/free-vector/note-music-logo-design_93835-645.jpg" alt="music thumbnail">
            <p id="song-name" style="text-align: center;">Song Title</p>
        </div>
        <audio id="videoPlayer" src="" controls></audio>
    </div>
    <div id="container"></div>


    <script src="plyr.polyfilled.js"></script>
    <script>
        //Variable declaration
        const fs = require('fs');
        const youtubedl = require('youtube-dl');

        let input = document.getElementById('searchInput');
        let container = document.getElementById('container');
        let videoPlayer = document.getElementById('videoPlayer');
        let songImg = document.getElementById('song-img');
        let songName = document.getElementById('song-name');
        const player = new Plyr('#videoPlayer');

        const savedFolder = `C:/Users/Coding/Documents/music`;

        var observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.target.nodeName === 'DIV' && entry.target.innerText.length === 0 && entry.intersectionRatio > 0) {
                    console.log('Retrieving video info');
                    youtubedl.getInfo(`https://www.youtube.com/watch?v=${entry.target.id}`, function(err, info) {
                        if (err) {
                            entry.target.classList = 'fade-in vid-title';
                            entry.target.innerText = 'Unable to get title :(';
                        } else {
                            entry.target.classList = 'fade-in vid-title';
                            entry.target.innerText = info.title;
                        }
                    })
                }
                if (entry.target.nodeName === 'IMG' && !entry.target.src && entry.intersectionRatio > 0) {
                    entry.target.classList += ' fade-in';
                    entry.target.src = entry.target.getAttribute('data-src');
                }
            });
        })

        //Event listeners
        input.addEventListener("keyup", function(event) {
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                search(event.target.value);
            }
        });

        //Functions
        function search(text) {
            container.innerHTML = '';
            fetch(`https://www.youtube.com/results?search_query=${text}`)
                .then(
                    function(response) {
                        if (response.status !== 200) {
                            console.log('Looks like there was a problem. Status Code: ' +
                                response.status);
                            return;
                        }
                        response.text().then(function(data) {
                            let regex = /"videoId":"([^">]+)"/g;
                            let found = data.match(regex);
                            let ids = {};
                            found.forEach((id) => {
                                var tmp = id.replace('"videoId":', '').replace(/"/g, '');
                                ids[tmp] = 1;
                            });
                            let i = 0;
                            for (key in ids) {
                                var div = document.createElement('div');
                                var img = document.createElement('img');
                                var bars = document.createElement('div');
                                var text = document.createElement('div');
                                bars.className = 'bars';
                                text.classList = 'bar bar1 loading';
                                text.id = key;
                                i++;
                                bars.append(text);
                                div.className = 'card';
                                img.setAttribute('data-src', `https://i.ytimg.com/vi/${key}/hqdefault.jpg`);
                                img.classList = 'video loading';
                                img.setAttribute('onclick', `playVideo("${key}")`);

                                //imageContainer.append(img);
                                div.append(img);
                                div.append(bars);
                                observer.observe(text);
                                observer.observe(img);
                                container.append(div);
                            }
                        });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error :-S', err);
                });
        }

        function playVideo(id) {
            songImg.src = `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
            songName.innerText = document.getElementById(id).innerText;
            try {
                if (fs.existsSync(__dirname + '/' + id + '.mp4')) {
                    videoPlayer.src = __dirname + '/' + id + '.mp4';
                    videoPlayer.play();
                } else {
                    download(id)
                }
            } catch (err) {
                console.error(err);
            }
        }

        function download(id) {
            try {
                const video = youtubedl(`https://www.youtube.com/watch?v=${id}`,
                    // Optional arguments passed to youtube-dl.
                    ['--format=18'],
                    // Additional options can be given for calling `child_process.execFile()`.
                    {
                        cwd: __dirname
                    });

                // Will be called when the download starts.
                video.on('info', function(info) {
                    console.log('Download started');
                    console.log('filename: ' + info._filename);
                    console.log('size: ' + info.size);
                })

                video.pipe(fs.createWriteStream(__dirname + '/' + id + '.mp4'));
                video.on('end', function() {
                    videoPlayer.src = __dirname + '/' + id + '.mp4';
                    videoPlayer.play();
                })
            } catch (error) {
                console.log(error);
                fs.unlink(__dirname + '/' + id + '.mp4', (err) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                })
            }

        }
    </script>
</body>

</html>